<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Italia Meteo ‚Äî Live Weather Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0B0E17;
    --card: #141826;
    --card-hover: #1A2035;
    --accent: #E8A838;
    --accent-glow: rgba(232, 168, 56, 0.25);
    --text: #E8E6E1;
    --text-muted: #8B8D97;
    --border: rgba(255,255,255,0.06);
    --green: #4ECDC4;
    --blue: #6CB4EE;
    --red: #E85D4A;
    --orange: #F4A261;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
  }

  header {
    padding: 28px 40px 20px;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 10;
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 14px;
  }

  .logo h1 {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--accent) 0%, #F4D58D 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .logo span {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .unit-toggle {
    display: flex;
    background: var(--card);
    border-radius: 8px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .unit-toggle button {
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .unit-toggle button.active {
    background: var(--accent);
    color: var(--bg);
  }

  .last-updated {
    font-size: 12px;
    color: var(--text-muted);
  }

  .layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    height: calc(100vh - 82px);
  }

  #map {
    width: 100%;
    height: 100%;
    background: var(--bg);
  }

  /* Custom Leaflet styling */
  .leaflet-container { background: var(--bg) !important; }
  .leaflet-tile-pane { filter: saturate(0.3) brightness(0.55) contrast(1.1); }
  .leaflet-control-zoom { border: 1px solid var(--border) !important; border-radius: 8px !important; overflow: hidden; }
  .leaflet-control-zoom a { background: var(--card) !important; color: var(--text-muted) !important; border-color: var(--border) !important; width: 34px !important; height: 34px !important; line-height: 34px !important; font-size: 16px !important; }
  .leaflet-control-zoom a:hover { background: var(--card-hover) !important; color: var(--text) !important; }
  .leaflet-control-attribution { background: rgba(11,14,23,0.85) !important; color: var(--text-muted) !important; font-size: 10px !important; }
  .leaflet-control-attribution a { color: var(--accent) !important; }

  /* Weather marker */
  .weather-marker {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s ease;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5));
  }
  .weather-marker:hover { transform: scale(1.15); }

  .marker-icon {
    font-size: 28px;
    line-height: 1;
  }

  .marker-temp {
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 13px;
    color: #fff;
    background: rgba(20, 24, 38, 0.9);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 6px;
    padding: 2px 7px;
    margin-top: 2px;
    white-space: nowrap;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }

  .marker-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-top: 1px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }

  /* Custom popup */
  .leaflet-popup-content-wrapper {
    background: var(--card) !important;
    border: 1px solid var(--border) !important;
    border-radius: 14px !important;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
    padding: 0 !important;
  }
  .leaflet-popup-tip { background: var(--card) !important; border: 1px solid var(--border) !important; }
  .leaflet-popup-content { margin: 0 !important; min-width: 240px; }
  .leaflet-popup-close-button { color: var(--text-muted) !important; font-size: 20px !important; top: 10px !important; right: 12px !important; }
  .leaflet-popup-close-button:hover { color: var(--text) !important; }

  .popup-inner {
    padding: 18px 20px;
  }

  .popup-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }

  .popup-icon { font-size: 36px; }

  .popup-city {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }

  .popup-region {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 600;
  }

  .popup-temp-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }

  .popup-temp-main {
    font-size: 42px;
    font-weight: 700;
    line-height: 1;
    letter-spacing: -2px;
  }

  .popup-desc {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 500;
  }

  .popup-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 16px;
  }

  .popup-detail {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .popup-detail-label {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
  }

  .popup-detail-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }

  /* Sidebar */
  .sidebar {
    background: var(--card);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
  }

  .sidebar::-webkit-scrollbar { width: 5px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

  .sidebar-header {
    padding: 22px 24px 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--card);
    z-index: 5;
  }

  .sidebar-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .sidebar-header p {
    font-size: 12px;
    color: var(--text-muted);
  }

  .region-list { padding: 8px 12px; }

  .region-card {
    display: grid;
    grid-template-columns: 40px 1fr auto;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .region-card:hover {
    background: var(--card-hover);
    border-color: var(--border);
  }

  .region-card.active {
    background: rgba(232, 168, 56, 0.08);
    border-color: rgba(232, 168, 56, 0.2);
  }

  .region-card .icon { font-size: 26px; text-align: center; }

  .region-info {
    min-width: 0;
  }

  .region-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .region-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 1px;
  }

  .region-temp {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -1px;
    text-align: right;
    white-space: nowrap;
  }

  .loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.6s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .loading-text {
    margin-top: 18px;
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    color: var(--text-muted);
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .powered-by {
    padding: 14px 24px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    position: sticky;
    bottom: 0;
    background: var(--card);
  }

  .powered-by a {
    color: var(--accent);
    text-decoration: none;
  }

  /* Temperature colors */
  .temp-freezing { color: #8EC5FC; }
  .temp-cold { color: #6CB4EE; }
  .temp-cool { color: #4ECDC4; }
  .temp-mild { color: #A8E6A3; }
  .temp-warm { color: #F4A261; }
  .temp-hot { color: #E85D4A; }
  .temp-extreme { color: #D62828; }

  /* Responsive */
  @media (max-width: 900px) {
    .layout {
      grid-template-columns: 1fr;
      grid-template-rows: 55vh 1fr;
    }
    .sidebar { border-left: none; border-top: 1px solid var(--border); }
    header { padding: 18px 20px 14px; }
    .logo h1 { font-size: 22px; }
    .logo span { display: none; }
  }
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">Caricamento meteo‚Ä¶</div>
</div>

<header>
  <div class="logo">
    <h1>Italia Meteo</h1>
    <span>Live Weather</span>
  </div>
  <div class="header-right">
    <div class="unit-toggle">
      <button class="active" id="btn-c" onclick="setUnit('C')">¬∞C</button>
      <button id="btn-f" onclick="setUnit('F')">¬∞F</button>
    </div>
    <div class="last-updated" id="last-updated"></div>
  </div>
</header>

<div class="layout">
  <div id="map"></div>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>20 Regioni</h2>
      <p>Current conditions by regional capital</p>
    </div>
    <div class="region-list" id="region-list"></div>
    <div class="powered-by">
      Weather data by <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a> (CC BY 4.0)
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ‚îÄ‚îÄ Italy's 20 regions with their capital cities ‚îÄ‚îÄ
const REGIONS = [
  { region: "Abruzzo", capital: "L'Aquila", lat: 42.3498, lon: 13.3995 },
  { region: "Basilicata", capital: "Potenza", lat: 40.6404, lon: 15.8056 },
  { region: "Calabria", capital: "Catanzaro", lat: 38.9098, lon: 16.5877 },
  { region: "Campania", capital: "Napoli", lat: 40.8518, lon: 14.2681 },
  { region: "Emilia-Romagna", capital: "Bologna", lat: 44.4949, lon: 11.3426 },
  { region: "Friuli Venezia Giulia", capital: "Trieste", lat: 45.6495, lon: 13.7768 },
  { region: "Lazio", capital: "Roma", lat: 41.9028, lon: 12.4964 },
  { region: "Liguria", capital: "Genova", lat: 44.4056, lon: 8.9463 },
  { region: "Lombardia", capital: "Milano", lat: 45.4642, lon: 9.1900 },
  { region: "Marche", capital: "Ancona", lat: 43.6158, lon: 13.5189 },
  { region: "Molise", capital: "Campobasso", lat: 41.5603, lon: 14.6684 },
  { region: "Piemonte", capital: "Torino", lat: 45.0703, lon: 7.6869 },
  { region: "Puglia", capital: "Bari", lat: 41.1171, lon: 16.8719 },
  { region: "Sardegna", capital: "Cagliari", lat: 39.2238, lon: 9.1217 },
  { region: "Sicilia", capital: "Palermo", lat: 38.1157, lon: 13.3615 },
  { region: "Toscana", capital: "Firenze", lat: 43.7696, lon: 11.2558 },
  { region: "Trentino-Alto Adige", capital: "Trento", lat: 46.0748, lon: 11.1217 },
  { region: "Umbria", capital: "Perugia", lat: 43.1107, lon: 12.3908 },
  { region: "Valle d'Aosta", capital: "Aosta", lat: 45.7375, lon: 7.3154 },
  { region: "Veneto", capital: "Venezia", lat: 45.4408, lon: 12.3155 },
];

// ‚îÄ‚îÄ WMO Weather Code mapping ‚îÄ‚îÄ
const WMO_CODES = {
  0: { desc: "Clear sky", icon: "‚òÄÔ∏è" },
  1: { desc: "Mainly clear", icon: "üå§Ô∏è" },
  2: { desc: "Partly cloudy", icon: "‚õÖ" },
  3: { desc: "Overcast", icon: "‚òÅÔ∏è" },
  45: { desc: "Fog", icon: "üå´Ô∏è" },
  48: { desc: "Rime fog", icon: "üå´Ô∏è" },
  51: { desc: "Light drizzle", icon: "üå¶Ô∏è" },
  53: { desc: "Moderate drizzle", icon: "üå¶Ô∏è" },
  55: { desc: "Dense drizzle", icon: "üåßÔ∏è" },
  56: { desc: "Freezing drizzle", icon: "üåßÔ∏è" },
  57: { desc: "Heavy freezing drizzle", icon: "üåßÔ∏è" },
  61: { desc: "Slight rain", icon: "üåßÔ∏è" },
  63: { desc: "Moderate rain", icon: "üåßÔ∏è" },
  65: { desc: "Heavy rain", icon: "üåßÔ∏è" },
  66: { desc: "Freezing rain", icon: "üåßÔ∏è" },
  67: { desc: "Heavy freezing rain", icon: "üåßÔ∏è" },
  71: { desc: "Slight snow", icon: "üå®Ô∏è" },
  73: { desc: "Moderate snow", icon: "üå®Ô∏è" },
  75: { desc: "Heavy snow", icon: "‚ùÑÔ∏è" },
  77: { desc: "Snow grains", icon: "‚ùÑÔ∏è" },
  80: { desc: "Slight showers", icon: "üå¶Ô∏è" },
  81: { desc: "Moderate showers", icon: "üåßÔ∏è" },
  82: { desc: "Violent showers", icon: "‚õàÔ∏è" },
  85: { desc: "Slight snow showers", icon: "üå®Ô∏è" },
  86: { desc: "Heavy snow showers", icon: "‚ùÑÔ∏è" },
  95: { desc: "Thunderstorm", icon: "‚õàÔ∏è" },
  96: { desc: "Thunderstorm w/ hail", icon: "‚õàÔ∏è" },
  99: { desc: "Thunderstorm w/ heavy hail", icon: "‚õàÔ∏è" },
};

let unit = 'C';
let weatherData = [];
let markers = [];
let map;

function getTempClass(tempC) {
  if (tempC <= 0) return 'temp-freezing';
  if (tempC <= 5) return 'temp-cold';
  if (tempC <= 12) return 'temp-cool';
  if (tempC <= 20) return 'temp-mild';
  if (tempC <= 30) return 'temp-warm';
  if (tempC <= 38) return 'temp-hot';
  return 'temp-extreme';
}

function toF(c) { return (c * 9/5 + 32).toFixed(0); }
function displayTemp(c) { return unit === 'C' ? `${Math.round(c)}¬∞C` : `${toF(c)}¬∞F`; }

function getWindDir(deg) {
  const dirs = ['N','NE','E','SE','S','SW','W','NW'];
  return dirs[Math.round(deg / 45) % 8];
}

function setUnit(u) {
  unit = u;
  document.getElementById('btn-c').classList.toggle('active', u === 'C');
  document.getElementById('btn-f').classList.toggle('active', u === 'F');
  renderSidebar();
  updateMarkers();
}

// ‚îÄ‚îÄ Initialize map ‚îÄ‚îÄ
function initMap() {
  map = L.map('map', {
    center: [42.0, 12.5],
    zoom: 6,
    minZoom: 5,
    maxZoom: 10,
    zoomControl: true,
  });

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);
}

// ‚îÄ‚îÄ Fetch weather from Open-Meteo ‚îÄ‚îÄ
async function fetchWeather() {
  const lats = REGIONS.map(r => r.lat).join(',');
  const lons = REGIONS.map(r => r.lon).join(',');

  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,precipitation&timezone=Europe/Rome`;

  const res = await fetch(url);
  const data = await res.json();

  // Open-Meteo returns an array when multiple coordinates are passed
  const results = Array.isArray(data) ? data : [data];

  weatherData = REGIONS.map((r, i) => {
    const current = results[i].current;
    const wmo = WMO_CODES[current.weather_code] || { desc: "Unknown", icon: "‚ùì" };
    return {
      ...r,
      temp: current.temperature_2m,
      feelsLike: current.apparent_temperature,
      humidity: current.relative_humidity_2m,
      windSpeed: current.wind_speed_10m,
      windDir: current.wind_direction_10m,
      precipitation: current.precipitation,
      weatherCode: current.weather_code,
      desc: wmo.desc,
      icon: wmo.icon,
    };
  });

  const now = new Date();
  document.getElementById('last-updated').textContent = `Updated ${now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
}

// ‚îÄ‚îÄ Render markers on map ‚îÄ‚îÄ
function updateMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  weatherData.forEach((d, i) => {
    const tempClass = getTempClass(d.temp);
    const html = `
      <div class="weather-marker">
        <div class="marker-icon">${d.icon}</div>
        <div class="marker-temp ${tempClass}">${displayTemp(d.temp)}</div>
        <div class="marker-name">${d.capital}</div>
      </div>
    `;

    const icon = L.divIcon({
      html: html,
      className: '',
      iconSize: [70, 64],
      iconAnchor: [35, 32],
    });

    const marker = L.marker([d.lat, d.lon], { icon }).addTo(map);

    marker.on('click', () => {
      openPopup(d, marker);
      highlightSidebar(i);
    });

    markers.push(marker);
  });
}

function openPopup(d, marker) {
  const tempClass = getTempClass(d.temp);
  const windDirStr = getWindDir(d.windDir);

  const html = `
    <div class="popup-inner">
      <div class="popup-region">${d.region}</div>
      <div class="popup-header">
        <div class="popup-icon">${d.icon}</div>
        <div class="popup-city">${d.capital}</div>
      </div>
      <div class="popup-temp-row">
        <div class="popup-temp-main ${tempClass}">${displayTemp(d.temp)}</div>
        <div class="popup-desc">${d.desc}<br><span style="font-size:11px;color:var(--text-muted)">Feels like ${displayTemp(d.feelsLike)}</span></div>
      </div>
      <div class="popup-details">
        <div class="popup-detail">
          <div class="popup-detail-label">Humidity</div>
          <div class="popup-detail-value">${d.humidity}%</div>
        </div>
        <div class="popup-detail">
          <div class="popup-detail-label">Wind</div>
          <div class="popup-detail-value">${d.windSpeed} km/h ${windDirStr}</div>
        </div>
        <div class="popup-detail">
          <div class="popup-detail-label">Precip.</div>
          <div class="popup-detail-value">${d.precipitation} mm</div>
        </div>
        <div class="popup-detail">
          <div class="popup-detail-label">Feels Like</div>
          <div class="popup-detail-value ${getTempClass(d.feelsLike)}">${displayTemp(d.feelsLike)}</div>
        </div>
      </div>
    </div>
  `;

  marker.bindPopup(html, { maxWidth: 280, offset: [0, -10] }).openPopup();
}

function highlightSidebar(idx) {
  document.querySelectorAll('.region-card').forEach((c, i) => {
    c.classList.toggle('active', i === idx);
  });
}

// ‚îÄ‚îÄ Render sidebar ‚îÄ‚îÄ
function renderSidebar() {
  const list = document.getElementById('region-list');
  // Sort by region name
  const sorted = weatherData.map((d, i) => ({ ...d, idx: i })).sort((a, b) => a.region.localeCompare(b.region));

  list.innerHTML = sorted.map(d => {
    const tempClass = getTempClass(d.temp);
    return `
      <div class="region-card" data-idx="${d.idx}" onclick="focusRegion(${d.idx})">
        <div class="icon">${d.icon}</div>
        <div class="region-info">
          <div class="region-name">${d.capital}</div>
          <div class="region-label">${d.region}</div>
        </div>
        <div class="region-temp ${tempClass}">${displayTemp(d.temp)}</div>
      </div>
    `;
  }).join('');
}

function focusRegion(idx) {
  const d = weatherData[idx];
  map.flyTo([d.lat, d.lon], 8, { duration: 0.8 });
  setTimeout(() => {
    openPopup(d, markers[idx]);
    highlightSidebar(idx);
  }, 400);
}

// ‚îÄ‚îÄ Main ‚îÄ‚îÄ
async function main() {
  initMap();
  await fetchWeather();
  updateMarkers();
  renderSidebar();
  document.getElementById('loading').classList.add('hidden');

  // Auto-refresh every 10 minutes
  setInterval(async () => {
    await fetchWeather();
    updateMarkers();
    renderSidebar();
  }, 600000);
}

main();
</script>
</body>
</html>
